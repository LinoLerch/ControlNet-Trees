# ControlNet-Trees
Training a custom [ControlNet](https://github.com/lllyasviel/ControlNet) to generate realistic tree images with [Stable Diffusion](https://github.com/CompVis/stable-diffusion) conditioned by hand-drawn-like tree skeletons

<img src="https://github.com/LinoLerch/ControlNet-Trees/assets/113920231/3e238764-e8ee-4db5-aabe-dd9e2e1e32ca" alt="drawing" width="550"/>

## Setup
- pip install -r requirements.txt

## Abstract
Text-to-image models such as Stable Diffusion made it possible to generate realistic images
from a simple text prompt. The ControlNet architecture extends this by adding conditional
images that allow to specify the layout of the desired image. In our project, we trained a
custom ControlNet to generate realistic tree images conditioned by a tree skeleton that
indicates shape and position. We started by building the dataset obtaining ground truth tree
images from a tree dataset and web scraping, plus expanding it through data augmentation.
We implemented a skeleton pipeline to turn these images into hand-drawn-like tree skeletons.
The text prompts were generated using an image captioning model. Our ControlNet model
was trained over several consecutive runs, first on the small then on the augmented dataset.
We defined four validation inputs to track the progress of the model during training and
compare the results with the baseline, the ControlNet scribble model. The results indicate
that our model does not follow the condition image as strictly as the ControlNet scribble
model. However, our model fixes problems of the baseline by avoiding leafless branches
and often producing more natural and photorealistic tree images.

## Build Dataset

### Ground truth tree images
- [Urban Street Tree Dataset](https://ytt917251944.github.io/dataset_jekyll/)
- [Google Image Scraper](https://github.com/ohyicong/Google-Image-Scraper)
- [Data augmentation](data_augmentation.ipynb)

<img src="https://github.com/LinoLerch/ControlNet-Trees/assets/113920231/42c28493-dfa4-49d7-9741-ee24fa0285f8" alt="drawing" width="550"/>

### Skeleton pipeline for condition images
1. Remove background
2. Binarize
3. Morphological Opening and Closing (to improve binary image)
4. Skeletonize

<img src="https://github.com/LinoLerch/ControlNet-Trees/assets/113920231/9331a66a-c1e7-427b-9a26-a0cb2f543189" alt="drawing" width="700"/>

### Text prompts
Training prompts are auto-generated by doing image captioning with [GIT: A Generative Image-to-text Transformer for Vision and Language](https://huggingface.co/docs/transformers/v4.30.0/en/model_doc/git#overview).

## Training
see [Training/README.md](Training/README.md)

## Results
![grafik](https://github.com/LinoLerch/ControlNet-Trees/assets/113920231/12be017c-0785-4371-bc86-87f649822ccc)

